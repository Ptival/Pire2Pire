%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                         %
% This file should only be made of \input %
%                                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Le démon}
    Nous avons choisi de développer le serveur sous forme d'un démon.
S'éxécutant en arrière-plan, il peut à tout moment être contacté par un client
ou par un autre serveur utilisant le même protocole de communication.

    \section{Gestion des clients}
    Dès qu'un client se connecte au démon, un thread est lancé et le gère
jusqu'à ce qu'il se déconnecte (cf. handle\_client () dans
\url{daemon/client_handler.c}). Il est ajouté à une liste doublement chaînée de 
clients connus, afin que l'application ait à tout moment une vision globale des 
clients qui lui sont affectés. 

\begin{lstlisting}
struct client {
    int                     socket;
    sem_t                   socket_lock;
    char                    *addr;
    pthread_t               thread_id;
    struct client_request   *requests;
    sem_t                   req_lock;
    struct client           *next;
    struct client           *prev;
};
\end{lstlisting}

    On remarque ici qu'il est nécessaire d'utiliser des sémaphores afin d'éviter
les "situations de compétition". Un client pourrait en effet avoir besoin de
modifier son champ "requests", et a besoin d'être sûr qu'une seule modification
puisse être effectuée à la fois.

    Dès qu'un client envoie une commande au démon via sa socket, une nouvelle
"struct client\_request" est créée. Elle est ajoutée à la liste doublement
chaînée contenant toutes les requêtes actives pour le client. Un thread est
lancé pour traiter cette requête, et appelle la fonction correspondante dans
\url{daemon/client_requests/}.



\begin{lstlisting}
struct client_request {
    char                    *cmd;
    struct client           *client;
    struct client_request   *prev;
    struct client_request   *next;
    pthread_t               thread_id;
};
\end{lstlisting}


	\section{Architecture du daemon}
	
	\section{Gestion du multithreading}
	
	\section{Gestion des fichiers}
	
    \section{Protocole client/daemon}
    blahblah

\begin{itemize}
\item{\textbf{set [option=value]}} Si "option=valeur" est spécifié, modifie la valeur
d'une option. Sinon, affiche la liste des options disponibles. Cette commande
est implémentée, mais aucune option n'existe.

\item{\textbf{help}} Affiche une aide indiquant la liste des options
disponibles. Implémentée.

\item{\textbf{list [options]}} Donne la liste des ressources des disponibles sur
le réseau sous la forme suivante : \textit{clé nom taille}.

\item{\textbf{get clé}} Récupère la ressource \textit{clé}.

\item{\textbf{info}} affiche des informations sur l'état du programme sous la
forme suivante :

There [is/are] n client(s) connected.     \\
There [is/are] n daemon(s) connected.     \\
You have n request(s) currently running : \\
1 - CMD1                                  \\ 
2 - CMD2                                  \\
...

\item{\textbf{download}} 

\item{\textbf{upload}}

\item{\textbf{connect ip:port}} demande au démon de se connecter à un autre
démon. Implémentée.

\item{\textbf{raw ip:port cmd}}

\end{itemize} 
	
	\section{Protocoles inter-daemons}

	\paragraph*{}conclusion...
